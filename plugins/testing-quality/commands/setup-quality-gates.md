---
description: Setup complete quality gates workflow with barrel-craft, Biome, Prettier, TypeScript, and Husky
---

# Setup Quality Gates

Setup a complete code quality workflow with automated checks that run before every commit.

## Overview

This command sets up a comprehensive quality gates system that ensures code quality through:

1. **Barrel files generation** (barrel-craft)
2. **Code formatting** (Biome + Prettier)
3. **Code linting** (Biome)
4. **Type checking** (TypeScript)
5. **Testing** (Bun test)
6. **Pre-commit hooks** (Husky + lint-staged)

## What Gets Installed

### Dependencies

```bash
bun add -D @biomejs/biome
bun add -D prettier prettier-package-json
bun add -D barrel-craft
bun add -D husky lint-staged
bun add -D @commitlint/cli @commitlint/config-conventional
```

### Configuration Files

- `biome.json` - Biome configuration
- `.prettierrc` - Prettier configuration
- `.prettierignore` - Prettier ignore patterns
- `barrel-craft.json` - Barrel file generation config
- `.lintstagedrc.json` - Pre-commit checks
- `commitlint.config.js` - Commit message linting
- `.husky/pre-commit` - Pre-commit hook
- `.husky/commit-msg` - Commit message validation hook

### Package.json Scripts

```json
{
  "scripts": {
    "craft": "barrel-craft",
    "craft:clean": "barrel-craft clean --force",
    "format": "biome format --write . && bun run format:md && bun run format:pkg",
    "format:md": "prettier --write '**/*.md' --log-level error",
    "format:pkg": "prettier-package-json --write package.json --log-level error",
    "lint": "biome check --write .",
    "lint:fix": "biome check --write . --unsafe",
    "type-check": "tsc --noEmit",
    "test": "bun test --timeout 10000",
    "test:watch": "bun test --watch --timeout 10000",
    "test:coverage": "bun test --coverage --timeout 10000",
    "quality": "bun run craft && bun run format && bun run lint && bun run type-check && bun test",
    "prepare": "husky"
  }
}
```

## Installation Steps

### 1. Install Dependencies

```bash
bun add -D @biomejs/biome prettier prettier-package-json barrel-craft
bun add -D husky lint-staged
bun add -D @commitlint/cli @commitlint/config-conventional
```

### 2. Copy Configuration Files

Copy templates from `plugins/testing-quality/templates/`:

```bash
# Biome configuration
cp plugins/testing-quality/templates/biome.json ./biome.json

# Prettier configuration
cp plugins/testing-quality/templates/.prettierrc ./.prettierrc
cp plugins/testing-quality/templates/.prettierignore ./.prettierignore

# Lint-staged configuration
cp plugins/testing-quality/templates/.lintstagedrc.json ./.lintstagedrc.json
```

### 3. Initialize Barrel-Craft

```bash
barrel-craft init
```

Then customize `barrel-craft.json` for your project structure:

```json
{
  "headerComment": "// Auto-generated by barrel-craft\n\n",
  "targets": ["src"],
  "forceGenerate": ["src/services", "src/pages"],
  "exclude": ["**/*.test.*", "**/*.spec.*", "**/*.d.ts"],
  "extensions": ["ts", "tsx"],
  "sortExports": true,
  "subdirectories": true
}
```

### 4. Setup Husky

```bash
bunx husky init
```

Create pre-commit hook:

```bash
cat > .husky/pre-commit << 'EOF'
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

bunx lint-staged
EOF

chmod +x .husky/pre-commit
```

Create commit-msg hook:

```bash
cat > .husky/commit-msg << 'EOF'
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

bunx --no -- commitlint --edit ${1}
EOF

chmod +x .husky/commit-msg
```

### 5. Create Commitlint Config

```bash
cat > commitlint.config.js << 'EOF'
export default {
  extends: ['@commitlint/config-conventional']
}
EOF
```

### 6. Add Scripts to package.json

Add all the scripts listed above to your package.json.

### 7. Create Bunfig.toml (Optional)

```toml
[test]
preload = ["./tests/setup.ts"]
coverageSkipTestFiles = true
coverageReporter = ["text", "lcov"]
coveragePathIgnorePatterns = [
  "coverage/**",
  "dist/**",
  "node_modules/**",
  "**/*.d.ts",
  "**/*.config.ts",
  "**/migrations/**",
  "**/index.ts"
]
```

## Usage

### Quality Gates Workflow

The quality gates sequence runs automatically on commit, or manually:

```bash
# Run full quality gates
bun run quality

# Run individual steps
bun run craft        # Generate barrel files
bun run format       # Format code
bun run lint         # Lint code
bun run type-check   # Type check
bun test             # Run tests
```

### Pre-commit Hooks

Pre-commit hooks run automatically when you commit:

```bash
git add .
git commit -m "feat: add new feature"
# Hooks run automatically:
# 1. lint-staged checks staged files
# 2. commitlint validates commit message
```

### Manual Checks

```bash
# Check what would be committed
git diff --staged

# Run lint-staged manually
bunx lint-staged

# Format specific files
biome format --write src/components/button.tsx
prettier --write README.md
```

## Customization

### Adjusting Barrel-Craft Patterns

Edit `barrel-craft.json`:

```json
{
  "targets": ["src", "lib"],
  "forceGenerate": [
    "src/domain",
    "src/application",
    "src/infrastructure",
    "src/presentation"
  ]
}
```

### Customizing Biome Rules

Edit `biome.json` to adjust linting rules:

```json
{
  "linter": {
    "rules": {
      "style": {
        "useConst": "warn" // Change from error to warn
      }
    }
  }
}
```

### Adjusting Lint-Staged

Edit `.lintstagedrc.json`:

```json
{
  "package.json": ["prettier-package-json --write --log-level error"],
  "*.{ts,tsx,js,jsx,css}": [
    "biome check --write --unsafe",
    "bun test --related" // Add test run for changed files
  ],
  "*.md": ["prettier --write --log-level error"]
}
```

## CI/CD Integration

### GitHub Actions

Create `.github/workflows/quality.yml`:

```yaml
name: Quality Checks

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install

      - name: Run quality gates
        run: bun run quality

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
```

## Troubleshooting

### Hooks Not Running

```bash
# Reinstall hooks
rm -rf .husky
bunx husky init
chmod +x .husky/pre-commit
chmod +x .husky/commit-msg
```

### Biome Errors

```bash
# Check configuration
biome check --verbose .

# Format without linting
biome format --write .
```

### TypeScript Errors

```bash
# Check TypeScript config
tsc --showConfig

# Run type check with details
tsc --noEmit --listFiles
```

### Barrel-Craft Not Generating

```bash
# Check with verbose output
barrel-craft -V

# Clean and regenerate
barrel-craft clean --dry-run
barrel-craft clean
barrel-craft
```

## Best Practices

1. **Run quality gates before pushing**: Always run `bun run quality` before pushing code
2. **Fix errors immediately**: Don't let quality issues accumulate
3. **Use verbose modes for debugging**: Add `-V` or `--verbose` flags when troubleshooting
4. **Keep configurations in sync**: Ensure all team members use the same config files
5. **Document exceptions**: If you need to disable a rule, document why
6. **Review pre-commit output**: Don't ignore hook messages
7. **Update dependencies regularly**: Keep tools up to date

## What Gets Checked

### Pre-commit (via lint-staged)

- ✅ package.json formatting
- ✅ TypeScript/JavaScript linting and formatting
- ✅ Markdown formatting
- ✅ Import organization
- ✅ File naming conventions

### Quality Gates (via `bun run quality`)

- ✅ Barrel file generation
- ✅ Code formatting (Biome + Prettier)
- ✅ Code linting (Biome)
- ✅ Type checking (TypeScript)
- ✅ Unit and integration tests

### Commit Message (via commitlint)

- ✅ Conventional commits format
- ✅ Type validation (feat, fix, docs, etc.)
- ✅ Scope validation
- ✅ Subject line requirements

## Next Steps

After setup:

1. **Commit the configuration files**:

   ```bash
   git add .
   git commit -m "chore: setup quality gates workflow"
   ```

2. **Run initial quality check**:

   ```bash
   bun run quality
   ```

3. **Fix any issues found**:

   ```bash
   bun run format
   bun run lint:fix
   ```

4. **Document the workflow** for your team in the project README

Quality gates are now active! Every commit will be automatically checked for quality issues.
